name: ðŸ§ª QA Tests
permissions:
  contents: read
on:
  push: {}
  workflow_call: {}

jobs:
  qa-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout zen-demo-go
        uses: actions/checkout@v5
        with:
          repository: Aikido-demo-apps/zen-demo-go
          path: zen-demo-go
          submodules: true

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.24

      - name: Use local firewall-go
        run: |
          cd zen-demo-go
          go get github.com/AikidoSec/firewall-go@$GITHUB_SHA
          go get github.com/AikidoSec/firewall-go/instrumentation/sources/gin-gonic/gin@$GITHUB_SHA
          go mod tidy
          sed -i "s|github.com/AikidoSec/firewall-go/cmd/zen-go@[^ ]*|github.com/AikidoSec/firewall-go/cmd/zen-go@$GITHUB_SHA|" Dockerfile

      - name: Run Firewall QA Tests
        uses: AikidoSec/firewall-tester-action@v1.0.7
        with:
          dockerfile_path: ./zen-demo-go/Dockerfile
          app_port: 3000
          sleep_before_test: 10
          test_timeout: 900
          skip_tests: test_stored_ssrf,test_ssrf_diffrent_port,test_ssrf,test_stored_ssrf_no_context,test_outbound_domain_blocking
