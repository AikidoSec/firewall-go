package ssrf

import (
	"errors"
	"strconv"

	"github.com/AikidoSec/firewall-go/internal/agent/ipaddr"
	"github.com/AikidoSec/firewall-go/internal/vulnerabilities"
)

// SSRFVulnerability detects server-side request forgery.
// It blocks outgoing HTTP requests to private/internal IPs when the hostname
// originates from user input (query params, headers, body, etc.).
var SSRFVulnerability = vulnerabilities.Vulnerability[*ScanArgs]{
	ScanFunction: scanFunction,
	Kind:         vulnerabilities.KindSSRF,
	Error:        "A server-side request forgery has been detected.",
}

type ScanArgs struct {
	Hostname    string
	Port        uint32
	ResolvedIPs []string // IPs to check; for literal IP hostnames pass []string{hostname}, for DNS-resolved pass the resolved IPs
}

func scanFunction(userInput string, args *ScanArgs) (*vulnerabilities.ScanResult, error) {
	if args == nil {
		return nil, errors.New("args cannot be nil")
	}

	hasPrivateIP := false
	for _, ip := range args.ResolvedIPs {
		if ipaddr.IsPrivateIP(ip) {
			hasPrivateIP = true
			break
		}
	}

	if !hasPrivateIP {
		return nil, nil
	}

	if findHostnameInUserInput(userInput, args.Hostname, args.Port) {
		metadata := map[string]string{
			"hostname": args.Hostname,
		}
		if args.Port > 0 {
			metadata["port"] = strconv.FormatUint(uint64(args.Port), 10)
		}
		return &vulnerabilities.ScanResult{
			DetectedAttack: true,
			Metadata:       metadata,
		}, nil
	}

	return nil, nil
}
