package ssrf

import (
	"errors"

	"github.com/AikidoSec/firewall-go/internal/agent/ipaddr"
	"github.com/AikidoSec/firewall-go/internal/vulnerabilities"
)

// SSRFVulnerability detects server-side request forgery.
// It blocks outgoing HTTP requests to private/internal IPs when the hostname
// originates from user input (query params, headers, body, etc.).
//
// This does not yet cover DNS-resolution based attacks (e.g. a public hostname
// that resolves to a private IP), redirect-based SSRF, or IMDS/stored SSRF.
var SSRFVulnerability = vulnerabilities.Vulnerability[*ScanArgs]{
	ScanFunction: scanFunction,
	Kind:         vulnerabilities.KindSSRF,
	Error:        "A server-side request forgery has been detected.",
}

type ScanArgs struct {
	Hostname string
	Port     uint32
}

func scanFunction(userInput string, args *ScanArgs) (*vulnerabilities.ScanResult, error) {
	if args == nil {
		return nil, errors.New("args cannot be nil")
	}

	if !ipaddr.IsPrivateIP(args.Hostname) {
		return nil, nil
	}

	if findHostnameInUserInput(userInput, args.Hostname, args.Port) {
		return &vulnerabilities.ScanResult{
			DetectedAttack: true,
			Metadata: map[string]string{
				"hostname": args.Hostname,
			},
		}, nil
	}

	return nil, nil
}
