package shellinjection

import (
	"errors"

	"github.com/AikidoSec/firewall-go/internal/vulnerabilities"
)

var ShellInjectionVulnerability = vulnerabilities.Vulnerability{
	ScanFunction: scanFunction,
	Kind:         vulnerabilities.KindShellInjection,
	Error:        "A shell injection has been detected.",
}

func scanFunction(userInput string, args []string) (*vulnerabilities.ScanResult, error) {
	if len(args) != 1 {
		return nil, errors.New("expected 1 argument")
	}

	command := args[0]

	trimmedCommand := trimInvisible(command)
	trimmedInputString := trimInvisible(userInput)

	if detectShellInjection(trimmedCommand, trimmedInputString) {
		return &vulnerabilities.ScanResult{
			DetectedAttack: true,
			Metadata: map[string]string{
				"command": command,
			},
		}, nil
	}

	return nil, nil
}
