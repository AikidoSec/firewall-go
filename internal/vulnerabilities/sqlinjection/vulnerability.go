package sqlinjection

import (
	"errors"

	"github.com/AikidoSec/firewall-go/internal/vulnerabilities"
	"github.com/AikidoSec/firewall-go/internal/vulnerabilities/zeninternals"
)

var SQLInjectionVulnerability = vulnerabilities.Vulnerability[*ScanArgs]{
	ScanFunction: scanFunction,
	Kind:         vulnerabilities.KindSQLInjection,
	Error:        "A sql injection has been detected.",
}

type ScanArgs struct {
	Statement string
	Dialect   string
}

func scanFunction(userInput string, args *ScanArgs) (*vulnerabilities.ScanResult, error) {
	if args == nil {
		return nil, errors.New("args cannot be nil")
	}

	statement := args.Statement
	dialect := zeninternals.GetSQLDialectFromString(args.Dialect)

	if detectSQLInjection(statement, userInput, dialect) {
		return &vulnerabilities.ScanResult{
			DetectedAttack: true,
			Metadata: map[string]string{
				"sql":     statement,
				"dialect": args.Dialect,
			},
		}, nil
	}

	return nil, nil
}
