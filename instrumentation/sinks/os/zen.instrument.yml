meta:
  name: os
  description: Protection from Local File Inclusion (LFI) Attacks.

rules:
  # Inject go:linkname declaration for Examine
  - id: os.Examine.linkname
    type: inject-decl
    package: os
    anchor: Getpid
    links:
      - github.com/AikidoSec/firewall-go/instrumentation/sinks/os
    template: |
      //go:linkname __aikido_os_Examine github.com/AikidoSec/firewall-go/instrumentation/sinks/os.Examine
      func __aikido_os_Examine(string) error

  # Prepend security check to os.OpenFile
  - id: os.OpenFile
    type: prepend
    package: os
    function: OpenFile
    template: |
      _aikido_block := __aikido_os_Examine({{ .Function.Argument 0 }})
      if _aikido_block != nil {
        return nil, _aikido_block
      }
