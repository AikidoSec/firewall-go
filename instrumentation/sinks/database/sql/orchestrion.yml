# yaml-language-server: $schema=https://datadoghq.dev/orchestrion/schema.json
meta:
  name: github.com/AikidoSec/firewall-go/instrumentation/sinks/database/sql
  description: |-
    Protection from SQL Injection.

aspects:
  # DB.QueryContext returns (*Rows, error) - should return error
  - id: database/sql.DB.QueryContext
    join-point:
      function-body:
        function:
          - receiver: "*database/sql.DB"
          - name: QueryContext
    advice:
      - prepend-statements:
          imports:
            sink: github.com/AikidoSec/firewall-go/instrumentation/sinks/database/sql
          template: |-
            _aikido_block := sink.ExamineContext({{ .Function.Argument 0}}, {{ .Function.Argument 1}}, "database/sql.DB.QueryContext")
            if _aikido_block != nil {
              return nil, _aikido_block
            }

  # DB.QueryRowContext returns *Row (no error) - return Row with error
  - id: database/sql.DB.QueryRowContext
    join-point:
      function-body:
        function:
          - receiver: "*database/sql.DB"
          - name: QueryRowContext
    advice:
      - prepend-statements:
          imports:
            sink: github.com/AikidoSec/firewall-go/instrumentation/sinks/database/sql
          template: |-
            _aikido_block := sink.ExamineContext({{ .Function.Argument 0}}, {{ .Function.Argument 1}}, "database/sql.DB.QueryRowContext")
            if _aikido_block != nil {
              return &Row{err: _aikido_block}
            }

  # DB.ExecContext returns (Result, error) - should return error
  - id: database/sql.DB.ExecContext
    join-point:
      function-body:
        function:
          - receiver: "*database/sql.DB"
          - name: ExecContext
    advice:
      - prepend-statements:
          imports:
            sink: github.com/AikidoSec/firewall-go/instrumentation/sinks/database/sql
          template: |-
            _aikido_block := sink.ExamineContext({{ .Function.Argument 0}}, {{ .Function.Argument 1}}, "database/sql.DB.ExecContext")
            if _aikido_block != nil {
              return nil, _aikido_block 
            }

  # DB.PrepareContext returns (*Stmt, error) - should return error
  - id: database/sql.DB.PrepareContext
    join-point:
      function-body:
        function:
          - receiver: "*database/sql.DB"
          - name: PrepareContext
    advice:
      - prepend-statements:
          imports:
            sink: github.com/AikidoSec/firewall-go/instrumentation/sinks/database/sql
          template: |-
            _aikido_block := sink.ExamineContext({{ .Function.Argument 0}}, {{ .Function.Argument 1}}, "database/sql.DB.PrepareContext")
            if _aikido_block != nil {
              return nil, _aikido_block
            }

  # Tx.QueryContext returns (*Rows, error) - should return error
  - id: database/sql.Tx.QueryContext
    join-point:
      function-body:
        function:
          - receiver: "*database/sql.Tx"
          - name: QueryContext
    advice:
      - prepend-statements:
          imports:
            sink: github.com/AikidoSec/firewall-go/instrumentation/sinks/database/sql
          template: |-
            _aikido_block := sink.ExamineContext({{ .Function.Argument 0}}, {{ .Function.Argument 1}}, "database/sql.Tx.QueryContext")
            if _aikido_block != nil {
              return nil, _aikido_block
            }

  # Tx.QueryRowContext returns *Row (no error) - return Row with error
  - id: database/sql.Tx.QueryRowContext
    join-point:
      function-body:
        function:
          - receiver: "*database/sql.Tx"
          - name: QueryRowContext
    advice:
      - prepend-statements:
          imports:
            sink: github.com/AikidoSec/firewall-go/instrumentation/sinks/database/sql
          template: |-
            _aikido_block := sink.ExamineContext({{ .Function.Argument 0}}, {{ .Function.Argument 1}}, "database/sql.Tx.QueryRowContext")
            if _aikido_block != nil {
              return &Row{err: _aikido_block}
            }

  # Tx.ExecContext returns (Result, error) - should return error
  - id: database/sql.Tx.ExecContext
    join-point:
      function-body:
        function:
          - receiver: "*database/sql.Tx"
          - name: ExecContext
    advice:
      - prepend-statements:
          imports:
            sink: github.com/AikidoSec/firewall-go/instrumentation/sinks/database/sql
          template: |-
            _aikido_block := sink.ExamineContext({{ .Function.Argument 0}}, {{ .Function.Argument 1}}, "database/sql.Tx.ExecContext")
            if _aikido_block != nil {
              return nil, _aikido_block
            }

  # Tx.PrepareContext returns (*Stmt, error) - should return error
  - id: database/sql.Tx.PrepareContext
    join-point:
      function-body:
        function:
          - receiver: "*database/sql.Tx"
          - name: PrepareContext
    advice:
      - prepend-statements:
          imports:
            sink: github.com/AikidoSec/firewall-go/instrumentation/sinks/database/sql
          template: |-
            _aikido_block := sink.ExamineContext({{ .Function.Argument 0}}, {{ .Function.Argument 1}}, "database/sql.Tx.PrepareContext")
            if _aikido_block != nil {
              return nil, _aikido_block
            }
