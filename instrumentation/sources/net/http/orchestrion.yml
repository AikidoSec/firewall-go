# yaml-language-server: $schema=https://datadoghq.dev/orchestrion/schema.json
meta:
  name: github.com/AikidoSec/firewall-go/instrumentation/sources/net/http
  description: |-
    something

aspects:
  - id: ServeMux-Handle
    join-point:
      all-of:
        - import-path: net/http
        - function-body:
            function:
              - name: Handle
              - receiver: "*net/http.ServeMux"
    advice:
      - inject-declarations:
          links:
            - github.com/AikidoSec/firewall-go/instrumentation/sources/net/http
          template: |-
            //go:linkname __aikido_http_wrapHandler github.com/AikidoSec/firewall-go/instrumentation/sources/net/http.WrapHandler
            func __aikido_http_wrapHandler(Handler) Handler
      - prepend-statements:
          template: |-
            {{ .Function.Argument 1 }} = __aikido_http_wrapHandler({{ .Function.Argument 1 }})

  - id: ServeMux-HandleFunc
    join-point:
      all-of:
        - import-path: net/http
        - function-body:
            function:
              - name: HandleFunc
              - receiver: "*net/http.ServeMux"
    advice:
      - inject-declarations:
          links:
            - github.com/AikidoSec/firewall-go/instrumentation/sources/net/http
          template: |-
            //go:linkname __aikido_http_middleware github.com/AikidoSec/firewall-go/instrumentation/sources/net/http.Middleware
            func __aikido_http_middleware(func(ResponseWriter, *Request)) func(ResponseWriter, *Request)
      - prepend-statements:
          template: |-
            {{ .Function.Argument 1 }} = __aikido_http_middleware({{ .Function.Argument 1 }})
